<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unidos por la vida de Fredy - Una Causa de Cuenca</title>
    <meta name="description"
        content="Únete a la cadena de solidaridad para que Fredy Vásquez vuelva a casa. Tu promesa de esperanza cuenta.">

    <link rel="icon" type="image/png" href="assets/favicon.png">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fredy.iaya.cloud/">
    <meta property="og:title" content="Unidos por Fredy">
    <meta property="og:description" content="Soutenez Fredy dans son combat. Chaque geste compte.">
    <meta property="og:image" content="https://fredy.iaya.cloud/assets/unidos-por-fredy.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://fredy.iaya.cloud/assets/unidos-por-fredy.jpg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        surface: 'oklch(97% 0.01 90)',
                        accent: 'oklch(60% 0.15 40)',
                        accentHover: 'oklch(55% 0.15 40)',
                        textMain: '#1a1a1a',
                        textMuted: '#4a4a4a'
                    },
                    fontFamily: {
                        serif: ['Fraunces', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- A/B Testing Logic (Stateless / Random / JS-Driven) -->
    <script>
            (function () {
                try {
                    // 1. Stateless Logic: Random 50/50 Split
                    var variant = Math.random() < 0.5 ? 'A' : 'B';

                    // 2. Expose Global State
                    window.ab_variant = variant;

                    // 3. Render Logic (Executed on DOM Ready to ensure elements exist)
                    document.addEventListener('DOMContentLoaded', () => {
                        console.log('A/B Strat: JS-Driven | Applying Variant:', variant);

                        const elemsA = document.querySelectorAll('.variant-content-a');
                        const elemsB = document.querySelectorAll('.variant-content-b');

                        if (variant === 'A') {
                            // Show A, Hide B
                            elemsA.forEach(el => el.classList.remove('hidden'));
                            elemsB.forEach(el => el.classList.add('hidden'));
                        } else {
                            // Show B, Hide A
                            elemsB.forEach(el => el.classList.remove('hidden'));
                            elemsA.forEach(el => el.classList.add('hidden'));
                        }
                    });

                } catch (e) {
                    console.error('A/B Error:', e);
                    // Fallback Safe Mode: Show A
                    document.addEventListener('DOMContentLoaded', () => {
                        document.querySelectorAll('.variant-content-a').forEach(el => el.classList.remove('hidden'));
                    });
                    window.ab_variant = 'A';
                }
            })();
    </script>

    <style>
        /* Base Styles */
        body {
            background-color: oklch(97% 0.01 90);
            /* fallback/match surface */
            color: #1a1a1a;
        }

        /* Utility */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body class="font-sans antialiased bg-surface selection:bg-accent selection:text-white">

    <!-- Main Navigation / Header (Simple) -->
    <header class="py-6 px-4 md:px-8 max-w-7xl mx-auto flex justify-between items-center">
        <div class="font-serif font-bold text-xl tracking-tight text-accent">
            #TodosPorFredy
        </div>
        <!-- Optional simplified nav or just a logo -->
    </header>

    <main>
        <!-- HERO SECTION -->
        <section class="relative w-full overflow-hidden min-h-[80vh] flex items-center justify-center">

            <!-- IMAGE BACKDROPS (Can differ by variant if desired, using same for now but ready for swap) -->
            <!-- Using v1 for A (Official/Institutional) and v2 for B (Human/Urgent) -->
            <div class="variant-content-a hidden absolute inset-0 z-0">
                <img src="./assets/fredy-h-16-9-v1.jpeg" alt="Fredy Vásquez"
                    class="w-full h-full object-cover opacity-90">
                <div class="absolute inset-0 bg-gradient-to-t from-surface via-surface/60 to-transparent"></div>
            </div>
            <div class="variant-content-b hidden absolute inset-0 z-0">
                <img src="./assets/fredy-h-16-9-v2.jpeg" alt="Fredy en la comunidad"
                    class="w-full h-full object-cover opacity-90">
                <div class="absolute inset-0 bg-gradient-to-t from-surface via-surface/60 to-transparent"></div>
            </div>

            <!-- CONTENT CONTAINER -->
            <div class="relative z-10 max-w-4xl mx-auto px-4 text-center mt-32 md:mt-0">

                <!-- VARIANT A: L'INSTITUTIONNEL -->
                <div class="variant-content-a hidden space-y-6">
                    <span
                        class="inline-block py-1 px-3 rounded-full bg-accent/10 text-accent font-semibold text-sm tracking-wide mb-2">
                        Solidaridad Oficial
                    </span>
                    <h1 class="font-serif text-5xl md:text-6xl lg:text-7xl font-bold leading-tight text-gray-900">
                        Fredy Vásquez: Una vida dedicada a Cuenca, una ciudad unida por su vida.
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
                        Honremos el compromiso de quien siempre trabajó por nosotros. Es momento de devolverle la
                        esperanza.
                    </p>
                    <div class="pt-2">
                        <!-- Donation Counter (Shared) -->
                        <div id="donation-counter-wrapper-a"
                            class="hidden mb-6 inline-flex flex-col items-center bg-white/80 backdrop-blur-sm rounded-xl border border-accent/20 px-6 py-3 shadow-lg transform transition-all hover:scale-105">
                            <span class="text-xs uppercase tracking-widest text-gray-500 font-semibold mb-1">Monto
                                Recaudado</span>
                            <div class="text-4xl font-serif font-bold text-accent tabular-nums relative"
                                id="donation-counter-a">
                                $0.00
                            </div>
                        </div>

                        <div class="pt-4">
                            <a href="#promesa"
                                class="inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white transition-all transform bg-accent rounded-full shadow-lg hover:bg-accentHover hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-accent/30">
                                Hacer una promesa de donación
                            </a>
                        </div>
                    </div>
                </div>

                <!-- VARIANT B: L'URGENCE HUMAINE -->
                <div class="variant-content-b hidden space-y-6">
                    <span
                        class="inline-block py-1 px-3 rounded-full bg-red-100 text-red-600 font-semibold text-sm tracking-wide mb-2 animate-pulse">
                        ⚠️ Ayuda Urgente
                    </span>
                    <h1 class="font-serif text-5xl md:text-6xl lg:text-7xl font-bold leading-tight text-gray-900">
                        Fredy nos necesita hoy. <span class="bg-accent/10 text-accent px-2">1$</span> puede cambiar el
                        destino de un guerrero.
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-700 max-w-2xl mx-auto leading-relaxed">
                        No es el monto, es la unión. Únete a la cadena de solidaridad para que Fredy vuelva a casa.
                    </p>
                    <div class="pt-2">
                        <!-- Donation Counter (Shared) -->
                        <div id="donation-counter-wrapper-b"
                            class="hidden mb-6 inline-flex flex-col items-center bg-white/80 backdrop-blur-sm rounded-xl border border-red-100 px-6 py-3 shadow-lg transform transition-all hover:scale-105">
                            <span class="text-xs uppercase tracking-widest text-red-500 font-semibold mb-1">Ayuda
                                Confirmada</span>
                            <div class="text-4xl font-serif font-bold text-gray-900 tabular-nums relative"
                                id="donation-counter-b">
                                $0.00
                            </div>
                        </div>

                        <div class="pt-4">
                            <a href="#promesa"
                                class="inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white transition-all transform bg-accent rounded-full shadow-lg hover:bg-accentHover hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-accent/30">
                                Quiero ayudar a Fredy ahora
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- MANIFESTO SECTION -->
        <section class="py-20 px-4 md:px-8 max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-12 items-center">
                <div class="md:col-span-5 relative">
                    <!-- Broken Grid / Artistic Image -->
                    <!-- Broken Grid / Artistic Image - Variant A -->
                    <div
                        class="variant-content-a hidden relative rounded-2xl overflow-hidden shadow-2xl rotate-1 hover:rotate-0 transition-transform duration-500">
                        <img src="./assets/fredy-v-9-16-v2.jpg" alt="Fredy Vásquez Recuperación"
                            class="w-full h-auto object-cover">
                    </div>
                    <!-- Broken Grid / Artistic Image - Variant B -->
                    <div
                        class="variant-content-b hidden relative rounded-2xl overflow-hidden shadow-2xl rotate-1 hover:rotate-0 transition-transform duration-500">
                        <img src="./assets/fredy-v-9-16-v2.jpg" alt="Fredy Vásquez Recuperación - Urgencia"
                            class="w-full h-auto object-cover">
                    </div>
                    <!-- Decorative element -->
                    <div class="absolute -bottom-6 -right-6 w-24 h-24 bg-accent/20 rounded-full z-[-1]"></div>
                </div>
                <div class="md:col-span-7 space-y-8">
                    <h2 class="font-serif text-4xl md:text-5xl font-bold text-gray-900">
                        El Camino hacia la Recuperación
                    </h2>
                    <div class="prose prose-lg text-gray-600 leading-relaxed font-sans">
                        <p>
                            <span class="font-bold text-accent">Fredy Vásquez</span>, nuestro gran amigo, se
                            encuentra en una situación crítica de salud.
                            Tras superar la etapa más dura en cuidados intensivos, ahora comienza su verdadera lucha:
                            un largo camino de recuperación y terapias especializadas.
                        </p>
                        <p>
                            Cuenca no deja a los suyos atrás. Tu apoyo, <span class="font-semibold text-gray-900">desde
                                tan solo 1$</span>, garantiza que Fredy reciba
                            el tratamiento de larga duración y el acompañamiento médico necesario para que su voz vuelva
                            a escucharse en nuestras calles.
                        </p>
                        <p class="italic text-lg border-l-4 border-accent pl-4 py-2 bg-white/50">
                            "Ayúdanos a cuidar de quien siempre cuidó de nuestra ciudad."
                        </p>

                        <!-- Banking Section -->
                        <div class="mt-8 bg-white/90 rounded-xl shadow-lg border-2 border-accent/10 p-6 md:p-8">
                            <h3 class="font-serif font-bold text-2xl text-gray-900 mb-3 text-center md:text-left">
                                Cada gesto cuenta: Tu apoyo, pequeño o grande, hace la diferencia
                            </h3>
                            <p class="text-gray-700 mb-6 text-lg">
                                Puedes realizar tu donación directamente a nuestra cuenta bancaria:
                            </p>
                            <div class="bg-surface border border-accent/20 rounded-xl p-6 shadow-inner">
                                <strong class="block text-accent text-xl mb-2 font-bold tracking-wide">BANCO DE
                                    GUAYAQUIL</strong>
                                <div class="text-gray-800 space-y-1 font-medium text-lg">
                                    <div>TITULAR: <span class="font-bold">Freddy Matias Vasquez Escobar</span></div>
                                    <div>CUENTA DE AHORROS: <span class="font-bold select-all">0012404136</span></div>
                                    <div>C.I: <span class="font-bold">0150455020</span></div>
                                    <div>Correo: <a href="mailto:fredymtias@gmail.com"
                                            class="font-bold select-all hover:text-accent transition-colors">fredymtias@gmail.com</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- FORM SECTION -->
        <section id="promesa" class="py-20 bg-white">
            <div class="max-w-3xl mx-auto px-4">
                <div class="bg-surface rounded-2xl shadow-xl p-8 md:p-12 border border-stone-100">
                    <h2 class="font-serif text-3xl md:text-4xl font-bold text-center mb-2 text-gray-900">
                        Tu promesa de esperanza
                    </h2>
                    <p class="text-center text-gray-500 mb-10">Completa el formulario para unirte a la causa.</p>

                    <form id="pledgeForm" class="space-y-6">
                        <input type="hidden" id="variant_id" name="variant_id" value="">

                        <!-- Name Row -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="firstName" class="block text-sm font-semibold text-gray-700">Nombre
                                    *</label>
                                <input type="text" id="firstName" name="first_name" required
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white"
                                    placeholder="Ej. Juan">
                            </div>
                            <div class="space-y-2">
                                <label for="lastName" class="block text-sm font-semibold text-gray-700">Apellido
                                    *</label>
                                <input type="text" id="lastName" name="last_name" required
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white"
                                    placeholder="Ej. Pérez">
                            </div>
                        </div>

                        <!-- Amount -->
                        <div class="space-y-2">
                            <label for="amount" class="block text-sm font-semibold text-gray-700">Monto de la promesa
                                ($)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
                                <input type="number" id="amount" name="pledge_amount" min="0" step="any"
                                    class="w-full pl-8 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white font-mono text-lg"
                                    placeholder="1.00" value="1.00">
                            </div>
                        </div>

                        <!-- Contact Preference -->
                        <!-- Contact Preference -->
                        <div class="space-y-3 p-4 bg-white/50 rounded-lg border border-gray-200">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Métodos de contacto
                                autorizados *</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="opt_in_email" id="opt_in_email"
                                        class="form-checkbox text-accent focus:ring-accent h-5 w-5">
                                    <span class="ml-2 text-gray-800">Email</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="opt_in_whatsapp" id="opt_in_whatsapp"
                                        class="form-checkbox text-accent focus:ring-accent h-5 w-5">
                                    <span class="ml-2 text-gray-800">WhatsApp</span>
                                </label>
                            </div>
                        </div>

                        <!-- Dynamic Contact Inputs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2 transition-opacity duration-300" id="emailContainer">
                                <label for="email" class="block text-sm font-semibold text-gray-700">
                                    Correo electrónico <span
                                        class="text-accent text-xs logic-indicator">(Requerido)</span>
                                </label>
                                <input type="email" id="email" name="email"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white"
                                    placeholder="juan@ejemplo.com">
                            </div>
                            <div class="space-y-2 transition-opacity duration-300 opacity-50" id="whatsappContainer">
                                <label for="whatsapp" class="block text-sm font-semibold text-gray-700">
                                    Teléfono WhatsApp <span
                                        class="text-gray-400 text-xs logic-indicator">(Opcional)</span>
                                </label>
                                <input type="tel" id="whatsapp" name="whatsapp"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white"
                                    placeholder="+593 99 999 9999">
                            </div>
                        </div>

                        <!-- Message -->
                        <div class="space-y-2">
                            <label for="message" class="block text-sm font-semibold text-gray-700">Mensaje de aliento
                                (Para el Libro de Oro)</label>
                            <textarea id="message" name="message" rows="3"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-accent focus:border-accent outline-none transition-colors bg-white"
                                placeholder="¡Fuerza Fredy!"></textarea>
                        </div>

                        <!-- Additional Checkboxes -->
                        <!-- Additional Checkboxes (Temporarily Disabled)
                        <div class="space-y-3 pt-2">
                            <label class="flex items-start cursor-pointer group">
                                <input type="checkbox" name="opt_in_news"
                                    class="mt-1 form-checkbox text-accent rounded focus:ring-accent border-gray-300 transition-colors">
                                <span
                                    class="ml-3 text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Quiero
                                    recibir noticias sobre la salud de Fredy.</span>
                            </label>
                            <label class="flex items-start cursor-pointer group">
                                <input type="checkbox" name="opt_in_bank"
                                    class="mt-1 form-checkbox text-accent rounded focus:ring-accent border-gray-300 transition-colors"
                                    checked>
                                <span
                                    class="ml-3 text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Quiero
                                    recibir los datos de la cuenta bancaria.</span>
                            </label>
                        </div>
                        -->

                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" id="submitBtn"
                                class="w-full group relative flex justify-center py-4 px-4 border border-transparent text-lg font-bold rounded-lg text-white bg-accent hover:bg-accentHover focus:outline-none focus:ring-4 focus:ring-accent/30 shadow-lg transition-all transform hover:-translate-y-0.5">
                                <span id="btnText">Enviar Promesa</span>
                                <span id="btnSpinner" class="hidden absolute right-4 top-1/2 -translate-y-1/2">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                        fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </span>
                            </button>
                        </div>

                        <!-- Success Message (Hidden) -->
                        <div id="successMessage"
                            class="hidden p-4 rounded-lg bg-green-50 border border-green-200 text-center">
                            <h3 class="text-green-800 font-bold text-lg mb-1">¡Gracias por tu apoyo!</h3>
                            <p class="text-green-700">Tu promesa ha sido registrada correctamente. Juntos somos más
                                fuertes.</p>
                        </div>
                        <!-- Error Message (Hidden) -->
                        <div id="errorMessage"
                            class="hidden p-4 rounded-lg bg-red-50 border border-red-200 text-center">
                            <h3 class="text-red-800 font-bold text-lg mb-1">Error</h3>
                            <p class="text-red-700" id="errorText">Hubo un problema al enviar. Por favor intenta de
                                nuevo.</p>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- BENTO GRID VOCES -->
        <!-- BENTO GRID GUESTBOOK (Livre d'or) -->
        <section class="py-20 px-4 md:px-8 max-w-7xl mx-auto">
            <h2 class="font-serif text-3xl md:text-4xl font-bold text-center mb-12 text-gray-900">
                Libro de Visitas
            </h2>
            <div id="guestbook-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Javascript will populate this -->
            </div>
            <div class="mt-12 text-center">
                <button id="loadMoreBtn"
                    class="hidden px-6 py-2 bg-white border border-gray-300 rounded-full text-gray-600 hover:bg-gray-50 transition-colors shadow-sm font-medium">
                    Ver más mensajes
                </button>
            </div>
        </section>

    </main>

    <footer style="background-color: oklch(15% 0.01 90);" class="py-12">
        <div class="max-w-7xl mx-auto px-4 flex flex-col items-center justify-center text-center space-y-8">
            <!-- Campaign Info -->
            <div class="space-y-2">
                <p class="font-serif font-bold text-2xl text-white">#TodosPorFredy</p>
                <p style="color: oklch(85% 0.01 90); opacity: 0.5;" class="text-sm">
                    Iniciativa ciudadana solidaria de Cuenca, Ecuador.
                </p>
            </div>

            <!-- Agency Signature -->
            <div class="flex items-center justify-center">
                <a href="https://iaya.cloud" target="_blank" rel="noopener noreferrer"
                    class="group flex items-center gap-2 decoration-none transition-opacity hover:opacity-100">
                    <span
                        style="font-family: 'Inter', sans-serif; font-size: 12px; color: oklch(85% 0.01 90); opacity: 0.5;">
                        Hecho con amor y cariño por
                    </span>
                    <img src="./assets/IAya-logo.png" alt="IAya Agency"
                        class="h-6 w-auto filter grayscale brightness-125 transition-all duration-300 group-hover:grayscale-0 group-hover:brightness-100"
                        loading="lazy" width="80" height="80">
                </a>
            </div>
        </div>
    </footer>

    <!-- LOGIC SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // 1. Set Hidden Variant Input
            const variantInput = document.getElementById('variant_id');
            if (variantInput) {
                variantInput.value = window.ab_variant || 'A';
            }

            // 2. Form Logic (Dynamic Requirements) & Guestbook

            // --- DONATION COUNTER LOGIC (Kinetic Typography) ---
            const counterElA = document.getElementById('donation-counter-a');
            const counterWrapperA = document.getElementById('donation-counter-wrapper-a');
            const counterElB = document.getElementById('donation-counter-b');
            const counterWrapperB = document.getElementById('donation-counter-wrapper-b');
            // Select active based on variant (logic below is generic, but UI needs to show up)

            // Show wrappers if we have JS
            if (window.ab_variant === 'A' && counterWrapperA) counterWrapperA.classList.remove('hidden');
            if (window.ab_variant === 'B' && counterWrapperB) counterWrapperB.classList.remove('hidden');

            let currentTotal = 0;

            function animateValue(obj, start, end, duration) {
                if (!obj) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const val = progress * (end - start) + start;
                    obj.innerHTML = '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        obj.innerHTML = '$' + end.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                };
                window.requestAnimationFrame(step);
            }

            async function fetchDonations() {
                try {
                    const res = await fetch('https://cms.iaya.cloud/items/donaciones');
                    const json = await res.json();
                    if (json.data) {
                        const total = json.data.reduce((sum, item) => sum + (parseFloat(item.monto) || 0), 0);

                        if (total !== currentTotal) {
                            if (window.ab_variant === 'A') animateValue(counterElA, currentTotal, total, 2000);
                            if (window.ab_variant === 'B') animateValue(counterElB, currentTotal, total, 2000); // Or both if unsure
                            // Safe to animate both?
                            if (counterElA) animateValue(counterElA, currentTotal, total, 1500);
                            if (counterElB) animateValue(counterElB, currentTotal, total, 1500);

                            currentTotal = total;
                        }
                    }
                } catch (e) {
                    console.error("Donation fetch error", e);
                }
            }

            // Init & Poll
            fetchDonations();
            setInterval(fetchDonations, 30000); // 30s poll


            // --- GUESTBOOK LOGIC (Existing - Kept) ---
            const grid = document.getElementById('guestbook-grid');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            let gbOffset = 0;
            const gbLimit = 12;

            async function loadGuestbook() {
                if (!grid) return;
                try {
                    const url = `https://cms.iaya.cloud/items/livre_or?filter[approuve][_eq]=true&sort=-date&limit=${gbLimit}&offset=${gbOffset}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    const items = json.data;

                    // Name Formatter for Latin American Names (Privacy)
                    const formatName = (str) => {
                        if (!str) return 'Anónimo';
                        const parts = str.trim().split(/\s+/);
                        if (parts.length <= 1) return parts[0];
                        if (parts.length === 2) return `${parts[0]} ${parts[1].charAt(0)}.`;
                        // > 2 words: First 2 full, rest initials
                        return `${parts[0]} ${parts[1]} ${parts.slice(2).map(p => p.charAt(0) + '.').join(' ')}`;
                    };

                    if (items && items.length > 0) {
                        items.forEach(item => {
                            const card = document.createElement('div');
                            card.className = "bg-white p-6 rounded-xl shadow-sm border border-stone-100 break-inside-avoid hover:shadow-md transition-shadow flex flex-col justify-between";
                            const displayName = formatName(item.nom);
                            card.innerHTML = `
                                <p class="italic text-gray-600 mb-4 text-sm leading-relaxed">"${item.messsage}"</p>
                                <div class="font-bold text-accent text-xs uppercase tracking-wide">— ${displayName}</div>
                            `;
                            grid.appendChild(card);
                        });
                        gbOffset += items.length;

                        if (items.length < gbLimit) {
                            loadMoreBtn.classList.add('hidden');
                        } else {
                            loadMoreBtn.classList.remove('hidden');
                        }
                    } else {
                        loadMoreBtn.classList.add('hidden');
                    }
                } catch (e) {
                    console.error("Guestbook load error", e);
                    loadMoreBtn.classList.add('hidden');
                }
            }

            if (grid) {
                loadGuestbook();
                if (loadMoreBtn) loadMoreBtn.addEventListener('click', loadGuestbook);
            }

            // --- FORM VALIDATION LOGIC ---
            const optInEmail = document.getElementById('opt_in_email');
            const optInWhatsapp = document.getElementById('opt_in_whatsapp');

            const emailInput = document.getElementById('email');
            const whatsappInput = document.getElementById('whatsapp');
            const emailContainer = document.getElementById('emailContainer');
            const whatsappContainer = document.getElementById('whatsappContainer');

            function updateRequirements() {
                // Email Rule
                if (optInEmail && optInEmail.checked) {
                    emailInput.required = true;
                    emailContainer.classList.remove('opacity-50');
                    emailContainer.querySelector('.logic-indicator').textContent = '(Requerido)';
                    emailContainer.querySelector('.logic-indicator').classList.add('text-accent');
                    emailContainer.querySelector('.logic-indicator').classList.remove('text-gray-400');
                } else {
                    emailInput.required = false;
                    emailContainer.classList.add('opacity-50');
                    emailContainer.querySelector('.logic-indicator').textContent = '(Opcional)';
                    emailContainer.querySelector('.logic-indicator').classList.remove('text-accent');
                    emailContainer.querySelector('.logic-indicator').classList.add('text-gray-400');
                }

                // Whatsapp Rule
                if (optInWhatsapp && optInWhatsapp.checked) {
                    whatsappInput.required = true;
                    whatsappContainer.classList.remove('opacity-50');
                    whatsappContainer.querySelector('.logic-indicator').textContent = '(Requerido)';
                    whatsappContainer.querySelector('.logic-indicator').classList.add('text-accent');
                    whatsappContainer.querySelector('.logic-indicator').classList.remove('text-gray-400');
                } else {
                    whatsappInput.required = false;
                    whatsappContainer.classList.add('opacity-50');
                    whatsappContainer.querySelector('.logic-indicator').textContent = '(Opcional)';
                    whatsappContainer.querySelector('.logic-indicator').classList.remove('text-accent');
                    whatsappContainer.querySelector('.logic-indicator').classList.add('text-gray-400');
                }
            }

            if (optInEmail && optInWhatsapp) {
                optInEmail.addEventListener('change', updateRequirements);
                optInWhatsapp.addEventListener('change', updateRequirements);
                // Initialize state
                updateRequirements();
            }


            // 3. Form Submission
            const form = document.getElementById('pledgeForm');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Basic Validation check handled by HTML5 'required' attributes mostly
                // Additional check just in case
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Loading State
                submitBtn.disabled = true;
                btnText.classList.add('opacity-0');
                btnSpinner.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                // Construct Payload
                const formData = new FormData(form);
                const payload = {
                    full_name: `${formData.get('first_name')} ${formData.get('last_name')}`.trim(),
                    email: formData.get('email') || "",
                    whatsapp: formData.get('whatsapp') || "",
                    pledge_amount: parseFloat(formData.get('pledge_amount') || "0"),
                    message: formData.get('message') || "",
                    variant_id: formData.get('variant_id'),
                    timestamp: new Date().toISOString(),
                    // Extra fields useful for the receiver but not strictly in the Schema requested? 
                    // The prompt asked for specific fields in the "Webhook Schema (Strict)".
                    // I will stick to the strict schema for the main object, but maybe send others?
                    // Strict Schema: full_name, email, whatsapp, pledge_amount, variant_id, timestamp.
                    // I will strictly allow only these in the JSON body.
                };

                // Remove email/whatsapp if empty strings to be cleaner? Or keep as empty strings. 
                // Schema says "string (conditionally required)". Assuming empty string is fine if not required.

                try {
                    // PRODUCTION WEBHOOK URL
                    const WEBHOOK_URL = 'https://n8nflow.iaya.cloud/webhook/donacion-fredy';

                    // console.log("Sending Payload:", payload);

                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // Success
                        form.reset();
                        form.classList.add('hidden');
                        successMessage.classList.remove('hidden');
                        // Scroll to success message
                        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        throw new Error('Server responded with ' + response.status);
                    }

                } catch (error) {
                    console.error('Submission Error:', error);
                    // For DEMO purposes, IF the URL is the placeholder, we might want to simulate success?
                    // The user asked to "Code" it, usually implies correct logic even if endpoint fails.
                    // I will show the error message.
                    errorMessage.classList.remove('hidden');
                    console.error("Submission failed.", payload);
                } finally {
                    // Reset Loading State
                    submitBtn.disabled = false;
                    btnText.classList.remove('opacity-0');
                    btnSpinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>

</html>